import { ref, computed, watchEffect } from 'vue';

type Locale = 'zh' | 'en';

const STORAGE_KEY = 'pdfmathtranslate-locale';

const dictionary: Record<Locale, Record<string, string>> = {
  zh: {
    'upload.title': '上传文档',
    'upload.subtitle': '登录后任务将永久保存，当前身份：',
    'upload.drop': '拖拽或点击上传 PDF / 图片',
    'upload.start': '开始解析',
    'upload.advanced': '高级配置（点击展开）',
    'upload.langFrom': '源语言',
    'upload.langTo': '目标语言',
    'upload.serviceTitle': '翻译服务',
    'upload.serviceSelect': '选择翻译服务',
    'upload.serviceDefault': '使用内置免费通道',
    'upload.serviceSiliconflow': 'SiliconFlow（自有密钥）',
    'upload.serviceDeepseek': 'DeepSeek（OpenAI 兼容）',
    'upload.serviceOpenAICompatible': '自定义（OpenAI 兼容）',
    'upload.siliconflowKey': 'SiliconFlow API 密钥（必填）',
    'upload.deepseekKey': 'DeepSeek API 密钥（必填）',
    'upload.deepseekModel': 'DeepSeek 模型（默认 deepseek-chat）',
    'upload.openaiCompatibleBaseUrl': '自定义 API 基础 URL（必填）',
    'upload.openaiCompatibleApiKey': '自定义 API 密钥（必填）',
    'upload.openaiCompatibleModel': '模型（默认 gpt-4o-mini）',
    'upload.error.siliconflowKeyMissing': 'SiliconFlow API 密钥不能为空。',
    'upload.error.deepseekKeyMissing': 'DeepSeek API 密钥不能为空。',
    'upload.error.openaiCompatibleBaseUrlMissing': '自定义 API 基础 URL 不能为空。',
    'upload.error.openaiCompatibleApiKeyMissing': '自定义 API 密钥不能为空。',
    'upload.error.openaiCompatibleModelMissing': '模型不能为空。',
    'upload.rememberConfig': '记住当前配置',
    'upload.guestNote': '访客模式任务将保留 7 天，注册后可永久保存。',
    'upload.loggedInNote': '已登录，任务会永久保存，可随时在任意设备访问。',
    'auth.loginTitle': '登录账号',
    'auth.registerTitle': '注册账号',
    'auth.loginHint': '输入已注册的账号信息，读取并同步个人任务。',
    'auth.registerHint': '注册成功后可永久保存任务，支持跨设备访问。',
    'auth.username': '用户名',
    'auth.password': '密码',
    'auth.loading': '提交中…',
    'auth.loginButton': '登录',
    'auth.registerButton': '注册',
    'auth.gotoRegister': '没有账号？立即注册',
    'auth.gotoLogin': '已有账号？返回登录',
    'auth.guestTip': '访客模式任务仅保留 7 天，建议注册账号以长期保存。',
    'auth.guest': '访客',
    'auth.guestHint': '访客模式 · 任务保留 7 天',
    'auth.loginShort': '登录',
    'auth.switchAccount': '账号设置',
    'task.listTitle': '任务列表',
    'task.empty': '上传任务后将在此显示进度',
    'task.refresh': '刷新',
    'task.statusLabel': '状态',
    'task.createdAt': '创建时间',
    'task.lastUpdated': '最近更新',
    'task.noResult': '尚未生成可下载文件',
    'main.chooseTask': '请选择左侧任务查看详情',
    'main.status': '状态',
    'main.progress': '进度',
    'main.downloadMono': '下载译文',
    'main.downloadDual': '下载双语',
    'main.downloadOriginal': '下载原文',
    'main.downloadZip': '下载打包 ZIP',
    'main.inProgress': '任务进行中，请稍候...',
    'main.failed': '任务失败',
    'main.summary': '任务摘要',
    'main.downloads': '下载中心',
    'main.events': '事件记录',
    'preview.title': '结果预览',
    'preview.single': '译文预览',
    'preview.dual': '双栏预览',
    'preview.close': '退出预览',
    'preview.loading': '加载预览中...',
    'preview.prompt': '选择上方按钮查看预览',
    'preview.source': '原文',
    'preview.target': '译文',
    'topbar.title': 'PDFMathTranslate',
    'topbar.subtitle': 'Web Console',
    'topbar.github': 'GitHub',
    'topbar.docs': '文档',
    'topbar.logout': '退出',
    'topbar.dark': '暗色模式',
    'topbar.light': '亮色模式',
    'topbar.refresh': '刷新任务',
    'topbar.loggedIn': '已登录',
    'topbar.user': '访客',
    'topbar.language': '语言',
    'set.lang': '语言'
  },
  en: {
    'upload.title': 'Upload Document',
    'upload.subtitle': 'Sign in to keep tasks forever. Current user: ',
    'upload.drop': 'Drag or click to upload PDF / Image',
    'upload.start': 'Start Parsing',
    'upload.advanced': 'Advanced Settings (click to expand)',
    'upload.langFrom': 'Source Language',
    'upload.langTo': 'Target Language',
    'upload.serviceTitle': 'Translation Service',
    'upload.serviceSelect': 'Choose Translation Service',
    'upload.serviceDefault': 'Use built-in free channel',
    'upload.serviceSiliconflow': 'SiliconFlow (bring your own key)',
    'upload.serviceDeepseek': 'DeepSeek (OpenAI compatible)',
    'upload.serviceOpenAICompatible': 'Custom (OpenAI compatible)',
    'upload.siliconflowKey': 'SiliconFlow API Key (required)',
    'upload.deepseekKey': 'DeepSeek API Key (required)',
    'upload.deepseekModel': 'DeepSeek model (default deepseek-chat)',
    'upload.openaiCompatibleBaseUrl': 'Base URL (required)',
    'upload.openaiCompatibleApiKey': 'API Key (required)',
    'upload.openaiCompatibleModel': 'Model (default gpt-4o-mini)',
    'upload.error.siliconflowKeyMissing': 'SiliconFlow API key is required.',
    'upload.error.deepseekKeyMissing': 'DeepSeek API key is required.',
    'upload.error.openaiCompatibleBaseUrlMissing': 'Base URL is required.',
    'upload.error.openaiCompatibleApiKeyMissing': 'API key is required.',
    'upload.error.openaiCompatibleModelMissing': 'Model is required.',
    'upload.rememberConfig': 'Remember current settings',
    'upload.guestNote': 'Guest tasks are kept for 7 days. Register to keep them forever.',
    'upload.loggedInNote': 'Signed in. Tasks are stored indefinitely and accessible on any device.',
    'auth.loginTitle': 'Sign In',
    'auth.registerTitle': 'Create Account',
    'auth.loginHint': 'Sign in with your existing account to sync personal tasks.',
    'auth.registerHint': 'Register to keep your tasks permanently and access them across devices.',
    'auth.username': 'Username',
    'auth.password': 'Password',
    'auth.loading': 'Submitting…',
    'auth.loginButton': 'Sign In',
    'auth.registerButton': 'Register',
    'auth.gotoRegister': 'Need an account? Register now',
    'auth.gotoLogin': 'Already have an account? Go back to sign in',
    'auth.guestTip': 'Guest mode keeps tasks for 7 days. Register to keep them longer.',
    'auth.guest': 'Guest',
    'auth.guestHint': 'Guest mode · Tasks kept 7 days',
    'auth.loginShort': 'Sign In',
    'auth.switchAccount': 'Account',
    'task.listTitle': 'Task List',
    'task.empty': 'Tasks will appear here once uploaded',
    'task.refresh': 'Refresh',
    'task.statusLabel': 'Status',
    'task.createdAt': 'Created',
    'task.lastUpdated': 'Updated',
    'task.noResult': 'No downloadable files yet',
    'main.chooseTask': 'Select a task on the left to view details',
    'main.status': 'Status',
    'main.progress': 'Progress',
    'main.downloadMono': 'Download Translation',
    'main.downloadDual': 'Download Bilingual',
    'main.downloadOriginal': 'Download Original',
    'main.downloadZip': 'Download ZIP Package',
    'main.inProgress': 'Task is running, please wait...',
    'main.failed': 'Task failed',
    'main.summary': 'Summary',
    'main.downloads': 'Downloads',
    'main.events': 'Event Log',
    'preview.title': 'Preview',
    'preview.single': 'Translation Preview',
    'preview.dual': 'Dual Preview',
    'preview.close': 'Close Preview',
    'preview.loading': 'Loading preview...',
    'preview.prompt': 'Use the buttons above to load a preview',
    'preview.source': 'Original',
    'preview.target': 'Translation',
    'topbar.title': 'PDFMathTranslate',
    'topbar.subtitle': 'Web Console',
    'topbar.github': 'GitHub',
    'topbar.docs': 'Docs',
    'topbar.logout': 'Logout',
    'topbar.dark': 'Dark Mode',
    'topbar.light': 'Light Mode',
    'topbar.refresh': 'Refresh Tasks',
    'topbar.loggedIn': 'Logged in',
    'topbar.user': 'visitor',
    'topbar.language': 'Language',
    'set.lang': 'Language'
  }
};

const locale = ref<Locale>(
  (localStorage.getItem(STORAGE_KEY) as Locale | null) ?? 'zh'
);

watchEffect(() => {
  localStorage.setItem(STORAGE_KEY, locale.value);
});

const t = (key: string) => {
  const table = dictionary[locale.value] ?? dictionary.zh;
  return table[key] ?? key;
};

const currentLocale = computed(() => locale.value);

function toggleLocale() {
  locale.value = locale.value === 'zh' ? 'en' : 'zh';
}

export function useI18n() {
  return {
    t,
    locale: currentLocale,
    toggleLocale,
    setLocale(newLocale: Locale) {
      locale.value = newLocale;
    }
  };
}
